# escape=`

FROM mcr.microsoft.com/windows/servercore:1809_amd64 as builder

SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]

ARG GIT_VERSION
ARG GIT_VERSION_BUILD
ARG GIT_256_CHECKSUM

# We have to enable TLS1.2 to download from GitHub.
RUN [Net.ServicePointManager]::SecurityProtocol = [Net.ServicePointManager]::SecurityProtocol -bor [Net.SecurityProtocolType]::Tls12; `
    Invoke-Webrequest -Uri "https://github.com/git-for-windows/git/releases/download/v${Env:GIT_VERSION}.windows.${Env:GIT_VERSION_BUILD}/Git-${Env:GIT_VERSION}-64-bit.exe" -OutFile gitsetup.exe -UseBasicParsing;

COPY [".\\helpers\\checksum.ps1", ".\\"]
RUN powershell -File .\checksum.ps1 -TargetFile gitsetup.exe -ExpectedHash ${Env:GIT_256_CHECKSUM}

# This argument list is taken from the chocolatey package:
# https://github.com/chocolatey-community/chocolatey-coreteampackages/blob/b992f41b9a887dad63aa4307913ae3485cb2b45b/automatic/git.install/tools/chocolateyInstall.ps1#L19
RUN Start-Process -Wait -FilePath  "c:\gitsetup.exe" -ArgumentList /S,/VERYSILENT,/SUPPRESSMSGBOXES,/NORESTART,/NOCANCEL,/SP-,/LOG,/COMPONENTS=gitlfs

FROM mcr.microsoft.com/windows/servercore:1809_amd64

USER ContainerAdministrator

COPY --from=builder ["C:\\Program Files\\Git", "C:\\Program Files\\Git"]
RUN setx PATH "%PATH%;C:\Program Files\Git\bin;C:\Program Files\Git\mingw64\bin;C:\Program Files\gitlab-runner-helper" /M

RUN git config --system core.longpaths true
RUN git lfs install --skip-repo

COPY [".\\binaries\\gitlab-runner-helper.x86_64-windows.exe", "C:\\Program Files\\gitlab-runner-helper\\gitlab-runner-helper.exe"]
