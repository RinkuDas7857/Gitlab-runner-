####################
# Changes patterns #
####################

.code-backstage-patterns: &code-backstage-patterns
  - ".gitlab-ci.yml"
  - ".golangci.yml"
  - ".gitlab/ci/**/*"
  - ".{gitattributes,markdownlint.json,stylelintrc,yamllint}"
  - "Makefile*"
  - "{apps,cache,ci,commands,common,dockerfiles,executors,helpers,log,network,packaging,referees,scripts,session,shells,tests,vendor}/**/*"
  - "go.*"
  - "main.go"
  - "tools.go"

.docs-patterns: &docs-patterns
  - "docs/**/*"
  - "scripts/lint-docs"

##############
# Conditions #
##############

.if-not-canonical-namespace: &if-not-canonical-namespace
  if: '$CI_PROJECT_NAMESPACE !~ /^gitlab-org($|\/)/'

.if-default-branch: &if-default-branch
  if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'

.if-release-candidate-tag: &if-release-candidate-tag
  if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+-rc[0-9]+/'

.if-stable-release-tag: &if-stable-release-tag
  if: '$CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+$/'

.if-merge-request-pipeline: &if-merge-request-pipeline
  if: $CI_PIPELINE_SOURCE == "merge_request_event"

.if-runner-merge-request-pipeline: &if-runner-merge-request-pipeline
  if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_PROJECT_PATH == "gitlab-org/gitlab-runner"

.if-runner-security-merge-request-pipeline: &if-runner-security-merge-request-pipeline
  if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_PROJECT_PATH == "gitlab-org/security/gitlab-runner"

.if-runner-default-branch: &if-runner-default-branch
  if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_PROJECT_PATH == "gitlab-org/gitlab-runner"

.if-runner-or-security-runner-default-branch: &if-runner-or-security-runner-default-branch
  if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && ($CI_PROJECT_PATH == "gitlab-org/gitlab-runner" || $CI_PROJECT_PATH == "gitlab-org/security/gitlab-runner")

.if-runner-or-security-runner-stable-ref: &if-runner-or-security-runner-stable-ref
  if: $CI_COMMIT_REF_NAME =~ /\A[0-9]+-[0-9]+-stable\z/ && ($CI_PROJECT_PATH == "gitlab-org/gitlab-runner" || $CI_PROJECT_PATH == "gitlab-org/security/gitlab-runner")

.if-runner-release-ref: &if-runner-release-ref
  if: $CI_COMMIT_REF_NAME =~ /\Av[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?\z/ && $CI_PROJECT_PATH == "gitlab-org/gitlab-runner"

.if-runner-stable-release-ref: &if-runner-stable-release-ref
  if: $CI_COMMIT_REF_NAME =~ /\Av[0-9]+\.[0-9]+\.[0-9]+?\z/ && $CI_PROJECT_PATH == "gitlab-org/gitlab-runner"

.if-security-runner-release-ref: &if-security-runner-release-ref
  if: $CI_COMMIT_REF_NAME =~ /\Av[0-9]+\.[0-9]+\.[0-9]+?\z/ && $CI_PROJECT_PATH == "gitlab-org/security/gitlab-runner"

.if-runner-bleeding-edge-release-ref: &if-runner-bleeding-edge-release-ref
  if: $CI_COMMIT_REF_NAME =~ /\Av[0-9]+\.[0-9]+\.[0-9]+-rc[0-9]+\z/ && $CI_PROJECT_PATH == "gitlab-org/gitlab-runner"

########################
# Default branch rules #
########################

.rules:default-branch-only:
  rules:
  - <<: *if-runner-or-security-runner-default-branch

.rules:default-branch-only:always:
  rules:
  - <<: *if-runner-or-security-runner-default-branch
    when: always

#######################
# Merge Request rules #
#######################

.rules:merge_request_pipelines:
  rules:
  - <<: *if-merge-request-pipeline
  - <<: *if-runner-or-security-runner-default-branch
  - <<: *if-runner-or-security-runner-stable-ref
  - <<: *if-runner-release-ref
  - <<: *if-security-runner-release-ref

.rules:merge_request_pipelines:no_docs:
  rules:
  - <<: *if-merge-request-pipeline
    changes: *code-backstage-patterns
  - <<: *if-runner-or-security-runner-default-branch
    changes: *code-backstage-patterns
  - <<: *if-runner-or-security-runner-stable-ref
    changes: *code-backstage-patterns
  - <<: *if-runner-release-ref
    changes: *code-backstage-patterns
  - <<: *if-security-runner-release-ref
    changes: *code-backstage-patterns
  - changes: *docs-patterns
    when: never

.rules:merge_request_pipelines:no_docs:always:
  rules:
  - <<: *if-merge-request-pipeline
    changes: *code-backstage-patterns
    when: always
  - <<: *if-runner-or-security-runner-default-branch
    changes: *code-backstage-patterns
    when: always
  - <<: *if-runner-or-security-runner-stable-ref
    changes: *code-backstage-patterns
    when: always
  - <<: *if-runner-release-ref
    changes: *code-backstage-patterns
    when: always
  - <<: *if-security-runner-release-ref
    changes: *code-backstage-patterns
    when: always
  - changes: *docs-patterns
    when: never

#################
# Release rules #
#################

.rules:release:all:
  rules:
  - <<: *if-not-canonical-namespace
    when: never
  - <<: *if-default-branch
  - <<: *if-release-candidate-tag
  - <<: *if-stable-release-tag

.rules:release:bleeding-edge:
  rules:
  - <<: *if-runner-default-branch
    changes: *code-backstage-patterns
  - <<: *if-runner-bleeding-edge-release-ref
    changes: *code-backstage-patterns
  - changes: *docs-patterns
    when: never

.rules:release:stable-or-rc:
  rules:
  - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$/ && $CI_PROJECT_PATH == "gitlab-org/gitlab-runner"
    changes: *code-backstage-patterns
    when: on_success
  - if: $CI_COMMIT_TAG =~ /^v[0-9]+\.[0-9]+\.[0-9]+(-rc[0-9]+)?$/ && $CI_PROJECT_PATH == "gitlab-org/security/gitlab-runner"
    changes: *code-backstage-patterns
    when: manual
  - changes: *docs-patterns
    when: never

.rules:release:stable:branch:
  rules:
  - <<: *if-runner-stable-release-ref
    changes: *code-backstage-patterns
  - <<: *if-security-runner-release-ref
    changes: *code-backstage-patterns
  - changes: *docs-patterns
    when: never

.rules:release:development:merge-requests:
  rules:
  - <<: *if-runner-merge-request-pipeline
    changes: *code-backstage-patterns
  - <<: *if-runner-security-merge-request-pipeline
    changes: *code-backstage-patterns
  - changes: *docs-patterns
    when: never

.rules:runner-only:release:development:merge-requests:
  rules:
  - <<: *if-runner-merge-request-pipeline
    changes: *code-backstage-patterns
  - changes: *docs-patterns
    when: never

.rules:prepare:ci:image:runner:merge-requests:
  rules:
  - <<: *if-runner-merge-request-pipeline
    changes:
    - dockerfiles/ci/*
    - .gitlab/ci/_common.gitlab-ci.yml
    - .gitlab/ci/prepare.gitlab-ci.yml
  - changes: *docs-patterns
    when: never

.rules:prepare:alpine-no-root:image:runner:merge-requests:
  rules:
  - <<: *if-runner-merge-request-pipeline
    changes:
    - tests/dockerfiles/alpine-no-root/*
    - .gitlab/ci/prepare.gitlab-ci.yml
  - changes: *docs-patterns
    when: never

##############
# Docs rules #
##############

.rules:docs:skip:
  rules:
  - changes: *docs-patterns
    when: never
  - when: on_success

.rules:docs:review:
  rules:
  - <<: *if-not-canonical-namespace
    when: never
  - <<: *if-merge-request-pipeline
    when: manual
